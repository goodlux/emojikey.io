<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>emojikey.io - Better LLM Relationships Through Emojis</title>

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://emojikey.io/" />
        <meta property="og:title" content="emojikey.io" />
        <meta
            property="og:description"
            content="Enhance your AI relationships with emojikeys - the key to better LLM conversations"
        />
        <meta property="og:image" content="https://emojikey.io/og-image.png" />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content="https://emojikey.io/" />
        <meta name="twitter:title" content="emojikey.io" />
        <meta
            name="twitter:description"
            content="Enhance your AI relationships with emojikeys - the key to better LLM conversations"
        />
        <meta name="twitter:image" content="https://emojikey.io/og-image.png" />

        <!-- Additional meta -->
        <meta
            name="description"
            content="Enhance your AI relationships with emojikeys - the key to better LLM conversations"
        />
        <link rel="icon" href="/favicon.ico" type="image/x-icon" />
        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
        <style>
            /* [Previous CSS remains unchanged] */
        </style>
    </head>
    <body>
        <!-- [Previous HTML remains unchanged until script section] -->

        <script>
            // Debug logging helper
            const debug = {
                log: (...args) => {
                    console.log("🐐 [DEBUG]", ...args);
                },
                error: (...args) => {
                    console.error("🐐 [ERROR]", ...args);
                }
            };

            // Environment detection
            const isLocal = window.location.hostname === "localhost" || 
                          window.location.hostname === "127.0.0.1";
            const env = isLocal ? "development" : "production";
            
            debug.log("Current environment:", env);

            const redirectUrl = env === "development" 
                ? "https://127.0.0.1:3000"
                : "https://emojikey.io";
            
            debug.log("Redirect URL:", redirectUrl);

            // Supabase initialization
            const supabaseUrl = "https://dasvvxptyafaiwkmmmqz.supabase.co";
            const supabaseAnonKey = "eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhc3Z2eHB0eWFmYWl3a21tbXF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM2MTM1NjEsImV4cCI6MjA0OTE4OTU2MX0.y9L2TahBajkUPQGJJ15kEckMK3sZDzuNL-2Mrmg_KoU";
            
            const supabase = window.supabase.createClient(
                supabaseUrl,
                supabaseAnonKey,
                {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true,
                        storage: window.localStorage,
                        storageKey: "emojikey-auth",
                        flowType: "implicit",
                        debug: true
                    }
                }
            );

            // Session management functions
            async function checkSession() {
                debug.log("Checking session...");
                const { data, error } = await supabase.auth.getSession();
                debug.log("Session check result:", { data, error });
                return data?.session;
            }

            async function showApiKey(userId) {
                debug.log("Getting/creating API key for user:", userId);
                const loginButton = document.getElementById("loginButton");
                const apiTokenDiv = document.getElementById("apiToken");

                try {
                    let { data, error } = await supabase
                        .from("api_keys")
                        .select("key")
                        .eq("user_id", userId)
                        .single();
                    
                    debug.log("API key lookup result:", { data, error });

                    if (error || !data) {
                        debug.log("Creating new API key");
                        const newKey = "ek_" + crypto.randomUUID().replace(/-/g, "");
                        const { error: insertError } = await supabase
                            .from("api_keys")
                            .insert([
                                {
                                    user_id: userId,
                                    key: newKey,
                                }
                            ]);

                        if (!insertError) {
                            apiTokenDiv.textContent = newKey;
                            debug.log("Created new API key");
                        } else {
                            debug.error("Failed to create API key:", insertError);
                        }
                    } else {
                        apiTokenDiv.textContent = data.key;
                        debug.log("Found existing API key");
                    }

                    apiTokenDiv.style.display = "block";
                    loginButton.textContent = "Logged in with GitHub";
                    loginButton.disabled = true;
                } catch (error) {
                    debug.error("API key error:", error);
                }
            }

            // Event Listeners
            document.getElementById("loginButton")
                .addEventListener("click", async () => {
                    debug.log("Login button clicked");
                    try {
                        const session = await checkSession();
                        if (session) {
                            debug.log("Using existing session");
                            await showApiKey(session.user.id);
                            return;
                        }

                        debug.log("Starting OAuth flow");
                        const { data, error } = await supabase.auth.signInWithOAuth({
                            provider: "github",
                            options: {
                                redirectTo: redirectUrl,
                                scopes: 'read:user'
                            }
                        });
                        
                        debug.log("OAuth initiation result:", { data, error });
                    } catch (error) {
                        debug.error("Login error:", error);
                    }
                });

            supabase.auth.onAuthStateChange(async (event, session) => {
                debug.log("Auth state changed:", event, session);
                if (event === "SIGNED_IN" && session) {
                    await showApiKey(session.user.id);
                }
            });

            // Initialize on load
            window.addEventListener("load", async () => {
                debug.log("Page loaded, checking session");
                const session = await checkSession();
                if (session) {
                    await showApiKey(session.user.id);
                }
            });

            // [Previous emoji rain code remains unchanged]
        </script>
    </body>
</html>